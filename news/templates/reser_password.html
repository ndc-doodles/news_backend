<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 flex items-center justify-center h-screen">

  <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
    <h2 class="text-2xl font-bold text-center mb-4">Reset Password</h2>
    <p class="text-center text-gray-500 mb-6">Enter your new password below</p>

    <p id="errorMsg" class="text-red-600 text-sm mb-4 hidden"></p>
    <p id="successMsg" class="text-green-600 text-sm mb-4 hidden"></p>

    <form id="resetForm">
      <input
        type="password"
        id="newPassword"
        placeholder="New Password"
        class="w-full px-4 py-2 mb-4 border rounded-lg"
      >

      <input
        type="password"
        id="confirmPassword"
        placeholder="Confirm Password"
        class="w-full px-4 py-2 mb-4 border rounded-lg"
      >

      <button
        type="submit"
        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-semibold transition"
      >
        Reset Password
      </button>
    </form>
  </div>

  <script>
    const uid = new URLSearchParams(window.location.search).get("uid");
    const token = new URLSearchParams(window.location.search).get("token");

    const resetForm = document.getElementById("resetForm");
    const newPassword = document.getElementById("newPassword");
    const confirmPassword = document.getElementById("confirmPassword");
    const errorMsg = document.getElementById("errorMsg");
    const successMsg = document.getElementById("successMsg");

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
          cookie = cookie.trim();
          if (cookie.startsWith(name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    resetForm.addEventListener("submit", (e) => {
      e.preventDefault();
      errorMsg.classList.add("hidden");
      successMsg.classList.add("hidden");

      if (!newPassword.value || !confirmPassword.value) {
        errorMsg.textContent = "All fields are required";
        errorMsg.classList.remove("hidden");
        return;
      }

      if (newPassword.value !== confirmPassword.value) {
        errorMsg.textContent = "Passwords do not match";
        errorMsg.classList.remove("hidden");
        return;
      }

      fetch(`/reset-password/?uid=${uid}&token=${token}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": getCookie("csrftoken")
        },
        body: new URLSearchParams({
          password: newPassword.value,
          confirm: confirmPassword.value
        })
      })
      .then(res => res.text())
      .then(() => {
        successMsg.textContent = "Password reset successfully!";
        successMsg.classList.remove("hidden");
        setTimeout(() => {
          window.location.href = "/"; // redirect to login or homepage
        }, 1500);
      })
      .catch(() => {
        errorMsg.textContent = "Something went wrong. Try again.";
        errorMsg.classList.remove("hidden");
      });
    });
  </script>
</body>
</html>
